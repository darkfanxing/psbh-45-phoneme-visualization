<!DOCTYPE html>
<html lang="zh-tw">
  <head>
    <meta charset="UTF-8" />
    <title>鋼琴</title>
    <style type="text/css">
      body {
        padding: 0;
        margin: 0;
        height: 100vh;
        overflow: hidden;
      }
      canvas {
        margin: 0 auto;
        display: none;
        position: fixed;
      }

      body img {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.8;
        z-index: -1;
      }

      .set-animate {
        transition: all 0.13s;
      }

      .set-animate-4 {
        transition: all 0.37s;
      }

      .default-circle {
        display: none;
        width: 0;
        height: 0;
        border-radius: 50%;
        border: 10px solid white;
      }

      .centered {
        position: fixed;
        top: 50%;
        left: 50%;
        /* bring your own prefixes */
        transform: translate(-50%, -50%);
      }
    </style>
  </head>
  <body>
    <img src="./bg.jpg">
    <div id="container" style="display: flex; justify-content: center; align-items: center; height: 100%;">
      <div id="button" style="transform: skewX(-10.1deg); padding: 10px; font-size: 30px; color: white; background-color: rgb(110, 174, 226);">點擊確認連線</div>
      <!-- <div id="small-circle" style="display: none; width: 0; height: 0; border-radius: 50%; border: 10px solid white;"></div> -->
      <canvas id="cvs">很抱歉，瀏覽器不支援 canvas</canvas>
    </div>
    
    
    
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
    <script type="text/javascript">
      let volume = 1;
      class MusicBox {
        constructor(options) {
          let defaults = {
            type: 'sine',  // sine | square | triangle | sawtooth
            duration: 2
          };

          this.opts = Object.assign(defaults, options);
          this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        createSound(frequency) {
          let oscillator = this.audioCtx.createOscillator();
          let gainNode = this.audioCtx.createGain();
          oscillator.connect(gainNode);
          gainNode.connect(this.audioCtx.destination);
          oscillator.type = this.opts.type; // type: sine | square | triangle | sawtooth
          oscillator.frequency.value = frequency;
          gainNode.gain.setValueAtTime(0, this.audioCtx.currentTime);
          gainNode.gain.linearRampToValueAtTime(volume, this.audioCtx.currentTime + 0.01);
          oscillator.start(this.audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + this.opts.duration);
          oscillator.stop(this.audioCtx.currentTime + this.opts.duration);
        }
      }

      
      let database, frequency, freqArray;
      const radius = 150;
      const phonemeFrequencies = {
        "C": {
          frequency: 262,
          index: 0
        },
        "Db": {
          frequency: 277,
          index: 1
        },
        "D": {
          frequency: 294,
          index: 2
        },
        "Eb": {
          frequency: 311,
          index: 3
        },
        "E": {
          frequency: 330,
          index: 4
        },
        "F": {
          frequency: 349,
          index: 5
        },
        "Gb": {
          frequency: 370,
          index: 6
        },
        "G": {
          frequency: 392,
          index: 7
        },
        "Ab": {
          frequency: 415,
          index: 8
        },
        "A": {
          frequency: 440,
          index: 9
        },
        "Bb": {
          frequency: 466,
          index: 10
        },
        "B": {
          frequency: 494,
          index: 11
        }
      };
      
      const firebaseConfig = {
        apiKey: "AIzaSyCHnHJKWv-eA-dr4rR4q_mj5rFq0ACn_U8",
        databaseURL: "https://psbh45-6ca43.firebaseio.com",
        projectId: "psbh45-6ca43",
        storageBucket: "psbh45-6ca43.appspot.com",
        messagingSenderId: "1050270713312",
        appId: "1:1050270713312:web:a84906a08269f15210d785",
        measurementId: "G-FM1CVEXZGP"
      };

      const colorsValue = ["#FF0000", "#FF7F00", "#FFFF00", "#00FF00", "#00FFFF", "#0000FF", "#8B00FF"];

      let music = new MusicBox({
        type: 'square',  // type: sine | square | triangle | sawtooth
        duration: 1
      });

      let exceeding = 0;
      let color;

      document.getElementById("button").onclick = () => {
        let cvs = document.getElementById("cvs");
        let ctx = cvs.getContext("2d");

        ctx.canvas.width = window.innerWidth;
        ctx.canvas.height = window.innerHeight;

        let centerX = cvs.width / 2;
        let centerY = cvs.height / 2;

        drawCircle(centerX, centerY, ctx);

        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        database.ref("/").remove();
        database.ref("/").limitToLast(1).on("value", value => {
          if (value.val() != null) {
            let phoneme = value.val()[Object.keys(value.val())[0]];
            volume = (Math.floor(Math.random() * 20) + 1) / 100 + 0.8
            music.createSound(phonemeFrequencies[phoneme].frequency);
            frequency = phonemeFrequencies[phoneme].index;
            document.getElementById("cvs").classList.add("set-animate");
            // document.getElementById("cvs").style.transitionTimingFunction = "cubic-bezier(.99, .01, .88, .45)";
            document.getElementById("cvs").style.transform = "scale(0.93)"
            setTimeout(() => {
              document.getElementById("cvs").style.transform = "scale(1.08)";
              setTimeout(() => {
                document.getElementById("cvs").style.transform = "scale(1)";
              }, 130)
            }, 130)
            
            animate();
          }
          });

        document.getElementById("button").style.display = "none";
        document.getElementsByTagName("canvas")[0].style.display = "block";
        // document.getElementById("small-circle").style.display = "block";
      };

      function animate(){
        let cvs = document.getElementById("cvs");
        let ctx = cvs.getContext("2d");

        ctx.canvas.width = window.innerWidth;
        ctx.canvas.height = window.innerHeight;

        let centerX = cvs.width / 2;
        let centerY = cvs.height / 2;
        
        drawCircle(centerX, centerY, ctx);

        const bars = 49;
        const theta = 2 * Math.PI / bars;

        frequency = parseInt((frequency + 1) * 4 - 1);
        freqArray = Array(48).fill(0);
        freqArray[frequency] = 100;
          
        for(let i = 1; i < 6; i++) {
          if(frequency - i < 0) {
            freqArray[bars - exceeding] = Math.floor(Math.random() * 100);
            freqArray[frequency + i] = Math.floor(Math.random() * 100);
            exceeding = exceeding + 1;
          } else if (frequency + i > bars) {
            freqArray[frequency - i] = Math.floor(Math.random() * 100);
            freqArray[exceeding] = Math.floor(Math.random() * 100);
            exceeding = exceeding + 1;
          } else {
            freqArray[frequency - i] = Math.floor(Math.random() * 100);
            freqArray[frequency + i] = Math.floor(Math.random() * 100);
          }
        }
        
        exceeding = 0;
        
        // for(let i = 0; i < freqArray.length; i++) {
        //   freqArray[i] = Math.floor(Math.random() * 100)
        // }

        color = colorsValue[Math.floor(Math.random() * 7)];
          
        for(let i = 0; i < bars; ++i) {
          let barHeight = freqArray[i];

          let startX = centerX + radius * Math.cos(theta * i);
          let startY = centerY + radius * Math.sin(theta * i);

          let endX = centerX + (radius + barHeight) * Math.cos(theta * i);
          let endY = centerY + (radius + barHeight) * Math.sin(theta * i);

          drawBar(startX, startY, endX, endY, freqArray[i], ctx);
        }

        test = 0;
        setTimeout(() => {
          let element = document.createElement("div");
          element.id = Date.now().toString();
          element.classList.add("default-circle", "centered");

          document.getElementsByTagName("body")[0].appendChild(element);

          document.getElementById(element.id).style.display = "block";
          document.getElementById(element.id).classList.add("set-animate-4");
          setTimeout(() => {
            document.getElementById(element.id).style.height = "290px";
            document.getElementById(element.id).style.width = "290px";
            setTimeout(() => {
              console.log(element.id);
              document.getElementById(element.id).remove();
            }, 370)
          }, 20)
          
        }, 10);

        continuousWeakenFreqArray();
      }

      let weakenAnimation;
      let test = 0;

      function continuousWeakenFreqArray() {
        weakenFreqArray();
        clearInterval(weakenAnimation);
        
        if (test < 20) {
          weakenAnimation = setInterval(continuousWeakenFreqArray, 20);
          test += 1;
        } else {
          test = 0;
        }
      }
      
      function weakenFreqArray() {
        let cvs = document.getElementById("cvs");
        let ctx = cvs.getContext("2d");

        ctx.canvas.width = window.innerWidth;
        ctx.canvas.height = window.innerHeight;

        let centerX = cvs.width / 2;
        let centerY = cvs.height / 2;

        drawCircle(centerX, centerY, ctx);

        const bars = 50;
        const theta = 2 * Math.PI / bars;
        
        
        freqArray.forEach((value, index, arr) => {
          if (value - 5 < 0) {
            arr[index] = 0;
          } else {
            arr[index] = value - 5;
          }
        })
          
        for(let i = 0; i < bars; ++i) {
          let barHeight = freqArray[i];

          let startX = centerX + radius * Math.cos(theta * i);
          let startY = centerY + radius * Math.sin(theta * i);

          let endX = centerX + (radius + barHeight) * Math.cos(theta * i);
          let endY = centerY + (radius + barHeight) * Math.sin(theta * i);

          drawBar(startX, startY, endX, endY, freqArray[i], ctx, color);
        }
      }


      function drawBar(startX, startY, endX, endY, freq, canvasContext){
        const barWidth = 8;

        canvasContext.strokeStyle = color;
        canvasContext.lineWidth = barWidth;
        canvasContext.beginPath();
        canvasContext.moveTo(startX, startY);
        canvasContext.lineTo(endX, endY);
        canvasContext.stroke();
      }

      function drawCircle(x, y, ctx) {
        ctx.shadowBlur = 20;
        ctx.shadowColor = "black";

        ctx.beginPath();
        ctx.arc(x, y, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = "#FFFFFF";
        ctx.lineWidth = 10;
        ctx.stroke();

        ctx.shadowBlur = 0;
      }
    </script>
  </body>
</html>
